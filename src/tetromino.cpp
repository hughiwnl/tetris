#include "tetromino.h"

// ---------------------------------------------------------------------------
// Piece rotation data — Tetris Guideline SRS
// rotations[state][cell][x, y] — offsets from pivot
// Row increases downward, col increases rightward
// States: 0=spawn, 1=CW90, 2=180, 3=CCW90
// ---------------------------------------------------------------------------

const TetrominoData TETROMINO_DATA[7] = {
    // I — cyan
    { { { {-1,0},{0,0},{1,0},{2,0} },
        { {1,-1},{1,0},{1,1},{1,2} },
        { {-1,1},{0,1},{1,1},{2,1} },
        { {0,-1},{0,0},{0,1},{0,2} } },
      sf::Color(0, 240, 240) },

    // J — blue
    { { { {-1,-1},{-1,0},{0,0},{1,0} },
        { {0,-1},{1,-1},{0,0},{0,1} },
        { {-1,0},{0,0},{1,0},{1,1} },
        { {0,-1},{0,0},{-1,1},{0,1} } },
      sf::Color(0, 0, 240) },

    // L — orange
    { { { {-1,0},{0,0},{1,0},{1,-1} },
        { {0,-1},{0,0},{0,1},{1,1} },
        { {-1,1},{-1,0},{0,0},{1,0} },
        { {-1,-1},{0,-1},{0,0},{0,1} } },
      sf::Color(240, 160, 0) },

    // O — yellow (all states identical)
    { { { {0,-1},{1,-1},{0,0},{1,0} },
        { {0,-1},{1,-1},{0,0},{1,0} },
        { {0,-1},{1,-1},{0,0},{1,0} },
        { {0,-1},{1,-1},{0,0},{1,0} } },
      sf::Color(240, 240, 0) },

    // S — green
    { { { {-1,0},{0,0},{0,-1},{1,-1} },
        { {0,-1},{0,0},{1,0},{1,1} },
        { {-1,1},{0,1},{0,0},{1,0} },
        { {-1,-1},{-1,0},{0,0},{0,1} } },
      sf::Color(0, 240, 0) },

    // T — purple
    { { { {-1,0},{0,0},{1,0},{0,-1} },
        { {0,-1},{0,0},{1,0},{0,1} },
        { {-1,0},{0,0},{1,0},{0,1} },
        { {0,-1},{-1,0},{0,0},{0,1} } },
      sf::Color(160, 0, 240) },

    // Z — red
    { { { {-1,-1},{0,-1},{0,0},{1,0} },
        { {1,-1},{0,0},{1,0},{0,1} },
        { {-1,0},{0,0},{0,1},{1,1} },
        { {0,-1},{-1,0},{0,0},{-1,1} } },
      sf::Color(240, 0, 0) },
};

// ---------------------------------------------------------------------------
// SRS Wall Kick Tables — Tetris Guideline
// offsets[from_rotation_state][kick_attempt_0..4][x, y]
// ---------------------------------------------------------------------------

// J, L, S, T, Z — clockwise kicks
const KickData SRS_KICKS_JLSTZ_CW = { {
    { {0,0},{-1,0},{-1,-1},{0,2},{-1,2} },  // 0->1
    { {0,0},{1,0},{1,1},{0,-2},{1,-2} },    // 1->2
    { {0,0},{1,0},{1,-1},{0,2},{1,2} },     // 2->3
    { {0,0},{-1,0},{-1,1},{0,-2},{-1,-2} }, // 3->0
} };

// J, L, S, T, Z — counter-clockwise kicks
const KickData SRS_KICKS_JLSTZ_CCW = { {
    { {0,0},{1,0},{1,-1},{0,2},{1,2} },     // 0->3
    { {0,0},{1,0},{1,1},{0,-2},{1,-2} },    // 1->0
    { {0,0},{-1,0},{-1,-1},{0,2},{-1,2} },  // 2->1
    { {0,0},{-1,0},{-1,1},{0,-2},{-1,-2} }, // 3->2
} };

// I — clockwise kicks
const KickData SRS_KICKS_I_CW = { {
    { {0,0},{-2,0},{1,0},{-2,1},{1,-2} },   // 0->1
    { {0,0},{-1,0},{2,0},{-1,-2},{2,1} },   // 1->2
    { {0,0},{2,0},{-1,0},{2,-1},{-1,2} },   // 2->3
    { {0,0},{1,0},{-2,0},{1,2},{-2,-1} },   // 3->0
} };

// I — counter-clockwise kicks
const KickData SRS_KICKS_I_CCW = { {
    { {0,0},{-1,0},{2,0},{-1,-2},{2,1} },   // 0->3
    { {0,0},{2,0},{-1,0},{2,-1},{-1,2} },   // 1->0
    { {0,0},{1,0},{-2,0},{1,2},{-2,-1} },   // 2->1
    { {0,0},{-2,0},{1,0},{-2,1},{1,-2} },   // 3->2
} };

// ---------------------------------------------------------------------------
// Tetromino class
// ---------------------------------------------------------------------------

Tetromino::Tetromino(TetrominoType type)
    : m_type(type), m_pos(0, 0), m_rotation(0)
{}

sf::Color Tetromino::color() const {
    return TETROMINO_DATA[static_cast<int>(m_type)].color;
}

std::array<sf::Vector2i, 4> Tetromino::worldCells() const {
    return worldCellsAt(m_pos, m_rotation);
}

std::array<sf::Vector2i, 4> Tetromino::worldCellsAt(sf::Vector2i pos, int rotation) const {
    const auto& rot = TETROMINO_DATA[static_cast<int>(m_type)].rotations[rotation & 3];
    std::array<sf::Vector2i, 4> result;
    for (int i = 0; i < 4; ++i)
        result[i] = pos + sf::Vector2i{rot[i][0], rot[i][1]};
    return result;
}
